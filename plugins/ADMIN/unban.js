const mess = require("@mess");
// Import predefined messages
// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©

const { removeUserFromBlock } = require("@lib/group");
// Import function to remove a user from the blocked list
// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†

const { getGroupMetadata } = require("@lib/cache");
// Import function to get group metadata
// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©

const { sendMessageWithMention, determineUser } = require("@lib/utils");
// Import helper functions to send message with mention & determine user
// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ù…Ù†Ø´Ù† ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

async function handle(sock, messageInfo) {
  const {
    remoteJid,
    isGroup,
    message,
    sender,
    content,
    prefix,
    command,
    mentionedJid,
    isQuoted,
    senderType,
  } = messageInfo;

  if (!isGroup) return; // Only for groups
  // ÙÙ‚Ø· Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª

  // Get group metadata
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  const groupMetadata = await getGroupMetadata(sock, remoteJid);
  const participants = groupMetadata.participants;

  // Check if sender is admin
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø±Ø³Ù„ Ù…Ø´Ø±Ù ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  const isAdmin = participants.some(
    (participant) => participant.id === sender && participant.admin
  );
  if (!isAdmin) {
    await sock.sendMessage(
      remoteJid,
      { text: mess.general.isAdmin },
      { quoted: message }
    );
    return;
  }

  // Determine which user to unban
  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù†Ù‡
  const userToBan = determineUser(mentionedJid, isQuoted, content);
  if (!userToBan) {
    return await sock.sendMessage(
      remoteJid,
      {
        text: `_âš ï¸ Usage Format:_ \n\n_ğŸ’¬ Example:_ _*${
          prefix + command
        } 6285246154386*_\n_âš ï¸ ØµÙŠØºØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:_ \n\n_ğŸ’¬ Ù…Ø«Ø§Ù„:_ _*${
          prefix + command
        } 6285246154386*_`,
      },
      { quoted: message }
    );
  }
  const whatsappJid = userToBan;

  try {
    // Attempt to remove user from block list
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
    const result = await removeUserFromBlock(remoteJid, whatsappJid);
    if (result) {
      await sendMessageWithMention(
        sock,
        remoteJid,
        `âœ… @${whatsappJid.split("@")[0]} _Successfully unbanned for this group_ / ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©`,
        message,
        senderType
      );
    } else {
      await sendMessageWithMention(
        sock,
        remoteJid,
        `âš ï¸ @${whatsappJid.split("@")[0]} _Not found in the ban list_ / Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø±`,
        message,
        senderType
      );
    }
  } catch (error) {
    console.log(error);
    await sendMessageWithMention(
      sock,
      remoteJid,
      `âŒ _Cannot unban number_ @${whatsappJid.split("@")[0]} / Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…`,
      message,
      senderType
    );
  }
}

module.exports = {
  handle,
  Commands: ["unban"],
  OnlyPremium: false,
  OnlyOwner: false,
};